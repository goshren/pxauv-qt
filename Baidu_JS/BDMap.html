<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
    <title>地图显示</title>
    <style>
        html, body, #container {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }
    </style>
    <script src="qrc:/map/qwebchannel.js"></script>
    <script type="text/javascript" src="https://api.map.baidu.com/api?v=1.0&&type=webgl&ak=vd15knkgsXClojiWvZt3UiqqT4yguxAh"></script>
</head>
<body>
    <div id="container"></div>
    <script>

    /********************** 全局变量 ****************************/
    var map = new BMapGL.Map("container");
    var convertor = new BMapGL.Convertor(); // 坐标转换器
    var markerBase = null;   // 岸基标记
    var markerTarget = null; // 信标标记

    // [新增] 轨迹绘制相关变量
    var trackPoints = [];    // 存储历史轨迹点
    var trackLine = null;    // 折线覆盖物

    /********************** 地图初始化 **************************/
    // 默认坐标（三亚），层级16
    var point = new BMapGL.Point(109.541, 18.319);
    map.centerAndZoom(point, 16);
    map.enableScrollWheelZoom(true);
    map.setHeading(0);
    map.setTilt(0);
    
    map.addControl(new BMapGL.ScaleControl());
    map.addControl(new BMapGL.ZoomControl());

    /********************** QT 交互注册 *************************/
    new QWebChannel(qt.webChannelTransport, function(channel) {
        window.bridgeObject = channel.objects.webBridge;
    });

    /********************** 核心功能函数 ************************/

    // 1. 设置【岸基】位置
    function setBasePoint(lng, lat) {
        var pt = new BMapGL.Point(lng, lat);
        convertor.translate([pt], 1, 5, function (data) {
            if(data.status === 0) {
                var p = data.points[0];
                if(markerBase) {
                    markerBase.setPosition(p);
                } else {
                    markerBase = new BMapGL.Marker(p);
                    map.addOverlay(markerBase);
                    var label = new BMapGL.Label("岸基(我)", { offset: new BMapGL.Size(15, -25) });
                    label.setStyle({ color: "red", fontSize: "14px", fontWeight: "bold", border: "1px solid red", padding: "2px", backgroundColor: "white"});
                    markerBase.setLabel(label);
                    map.panTo(p); 
                }
            }
        });
    }

    // 2. 设置【信标】位置 + [新增] 轨迹绘制
    function setTargetPoint(lng, lat) {
        var pt = new BMapGL.Point(lng, lat);
        convertor.translate([pt], 1, 5, function (data) {
            if(data.status === 0) {
                var p = data.points[0];
                
                // A. 更新图标位置
                if(markerTarget) {
                    markerTarget.setPosition(p);
                } else {
                    markerTarget = new BMapGL.Marker(p);
                    map.addOverlay(markerTarget);
                    var label = new BMapGL.Label("潜器", { offset: new BMapGL.Size(15, -25) });
                    label.setStyle({ color: "blue", fontSize: "14px", fontWeight: "bold", border: "1px solid blue", padding: "2px", backgroundColor: "white"});
                    markerTarget.setLabel(label);
                }

                // B. [新增] 绘制历史轨迹
                trackPoints.push(p); // 加入路径点
                
                if (trackLine) {
                    trackLine.setPath(trackPoints); // 更新折线路径
                } else {
                    // 创建折线: 蓝色, 宽度4, 透明度0.5
                    trackLine = new BMapGL.Polyline(trackPoints, {
                        strokeColor: "blue",
                        strokeWeight: 4,
                        strokeOpacity: 0.5
                    });
                    map.addOverlay(trackLine);
                }
            }
        });
    }

    // 3. [新增] 清除轨迹函数
    function clearTrack() {
        if(trackLine) {
            map.removeOverlay(trackLine);
            trackLine = null;
        }
        trackPoints = []; // 清空数组
    }

    // 兼容旧接口
    function setPoint(lng, lat) {
        setBasePoint(lng, lat);
    }

    </script>
</body>
</html>